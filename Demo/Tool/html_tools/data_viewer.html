<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>Data Viewer</title>

    <style type="text/css">
        body {font: 10pt arial;}
    </style>

    <script type="text/javascript" src="graph.js"></script>
    <!--[if IE]><script type="text/javascript" src="../excanvas.js"></script><![endif]-->
    <link rel="stylesheet" type="text/css" href="graph.css">

    <script type="text/javascript">
    
        var parsedJSONs = [];
        var counter = 0;

        // Called when the Visualization API is loaded.
        function drawVisualization() {

            //console.log(parsedJSONs);
            var datasets = [];
            for (var i = 0, dataJSON; dataJSON = parsedJSONs[i]; i++) {

                var dataset = {
                    'label': dataJSON.name,
                    'data': []
                };

                for (var j = 0; j < dataJSON.max_num; ++j) {
                    var d = new Date();
                    d.setMinutes(0);
                    d.setMilliseconds(0);

                    //d.setMilliseconds(j*dataJSON.timer);
                    d.setSeconds(j*dataJSON.timer);
                    dataset.data.push({
                        'date': d,
                        'value': dataJSON.data[j]
                    });
                };

                //console.log(dataset);
                datasets.push(dataset);
            }


            // specify options
            var options = {
                'width':  '100%',
                'height': '350px'
            };

            // Instantiate our graph object.
            var graph = new links.Graph(document.getElementById('mygraph'));

            // Draw our graph with the created data and options
            graph.draw(datasets, options);

            // use the Links event bus (not googles event bus)
            var onRangeChange = function (params) {
                document.getElementById('range').innerHTML =
                        'Visible range from ' + params.start + ' to ' + params.end;
            };
            links.events.addListener(graph, 'rangechange', onRangeChange);
        }

        function handleFileSelect(evt) {
        var files = evt.target.files; // FileList object

        // files is a FileList of File objects. List some properties.
        var output = [];
        parsedJSONs.length = 0;
        counter = files.length;

        for (var i = 0, f; f = files[i]; i++) {
            output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
                      f.size, ' bytes, last modified: ',
                      f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
                      '</li>');

            var reader = new FileReader();
            // Closure to capture the file information.
            reader.onload = (function (theFile) {
                return function (e) {
                    // Render thumbnail.
                    var JsonObj = e.target.result;
                    var parsedJSON = JSON.parse(JsonObj);
                    //console.log(parsedJSON);
                    parsedJSONs.push(parsedJSON);

                    --counter;
                    if(counter == 0)
                    {
                        console.log("all json read finished, draw");
                        drawVisualization();
                    }

                };
            })(f);

            // Read in JSON as a data URL.
            reader.readAsText(f);
        }
        document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
      }


      function on_load()
      {
          document.getElementById('files').addEventListener('change', handleFileSelect, false);
      }

    </script>
</head>

<body onload="on_load();">
<h1>Data Viewer</h1>
<div id="mygraph"></div>
<p id="range"></p>
<div id="info"></div>
<input type="file" id="files" name="files[]" multiple />
<output id="list"></output>
</body>
</html>
